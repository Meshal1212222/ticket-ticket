<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÙˆØ§ØªØ³Ø§Ø¨ - Ù‚ÙˆÙ„Ø¯Ù† ØªÙŠÙƒØª</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#075e54">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #111b21;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ==================== MOBILE FIRST DESIGN ==================== */

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            background: #111b21;
        }

        /* Main Header - WhatsApp Style */
        .main-header {
            background: #075e54;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .main-header h1 {
            font-size: 1.4em;
            font-weight: 600;
        }

        .header-icons {
            display: flex;
            gap: 20px;
            font-size: 1.3em;
        }

        .header-icons a, .header-icons span {
            color: white;
            text-decoration: none;
            cursor: pointer;
            opacity: 0.9;
        }

        /* Search Box */
        .search-container {
            padding: 8px 12px;
            background: #111b21;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #202c33;
            border-radius: 8px;
            padding: 10px 16px;
            gap: 12px;
        }

        .search-box input {
            flex: 1;
            background: none;
            border: none;
            color: #e9edef;
            font-size: 1em;
            outline: none;
        }

        .search-box input::placeholder {
            color: #8696a0;
        }

        .search-icon {
            color: #8696a0;
            font-size: 1.1em;
        }

        /* Filter Tabs - WhatsApp Style */
        .filter-tabs {
            display: flex;
            padding: 8px 12px;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .filter-tabs::-webkit-scrollbar {
            display: none;
        }

        .filter-tab {
            padding: 8px 16px;
            background: #202c33;
            color: #00a884;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.2s;
        }

        .filter-tab.active {
            background: #00a884;
            color: #111b21;
        }

        /* Chat List */
        .chats-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            scroll-behavior: smooth;
            will-change: scroll-position;
            touch-action: pan-y;
        }

        .chat-item {
            display: flex;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(134, 150, 160, 0.15);
            transition: background 0.15s;
            align-items: center;
        }

        .chat-item:active {
            background: #202c33;
        }

        .chat-item.active {
            background: #2a3942;
        }

        .chat-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00a884, #075e54);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.4em;
            font-weight: 500;
            margin-left: 15px;
            flex-shrink: 0;
        }

        .chat-avatar.group-avatar {
            background: linear-gradient(135deg, #53bdeb, #00a884);
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .chat-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-name {
            color: #e9edef;
            font-size: 1.05em;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .chat-time {
            color: #8696a0;
            font-size: 0.8em;
            flex-shrink: 0;
        }

        .chat-time.unread {
            color: #00a884;
        }

        .chat-bottom-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-preview {
            color: #8696a0;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            margin-left: 10px;
        }

        .unread-badge {
            background: #00a884;
            color: #111b21;
            border-radius: 50%;
            min-width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 600;
            flex-shrink: 0;
        }

        /* Bottom Navigation - WhatsApp Style */
        .bottom-nav {
            display: flex;
            background: #202c33;
            border-top: 1px solid #2a3942;
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            color: #8696a0;
            text-decoration: none;
            font-size: 0.75em;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: #00a884;
        }

        .nav-item .nav-icon {
            font-size: 1.6em;
        }

        .nav-item .nav-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            background: #00a884;
            color: #111b21;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .nav-icon-container {
            position: relative;
        }

        /* ==================== CHAT VIEW ==================== */

        .chat-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0b141a;
            display: none;
            flex-direction: column;
            z-index: 200;
        }

        .chat-view.active {
            display: flex;
        }

        .chat-header {
            background: #075e54;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-top: calc(10px + env(safe-area-inset-top));
        }

        .back-btn {
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00a884, #075e54);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1em;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-name {
            color: white;
            font-size: 1.1em;
            font-weight: 500;
        }

        .chat-header-status {
            color: rgba(255,255,255,0.7);
            font-size: 0.8em;
        }

        .chat-header-icons {
            display: flex;
            gap: 20px;
            color: white;
            font-size: 1.3em;
        }

        .chat-header-icons span {
            cursor: pointer;
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px 12px;
            background: #0b141a;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyBAMAAADsEZWCAAAAG1BMVEUNExgNExgNExgNExgNExgNExgNExgNExgNExgPSv+nAAAACHRSTlMIEBggKDA4QH+9qYkAAABfSURBVDjLY2AYBfQABqJUKDMwOBClAqSbgUGBKBXK6AwMTESpUGZkYBAgSoWyPAMDPVEqkFWKMBADGBiJcsIIVUGCCuRIkCZSBUTIkiog0RUQISvJARyhKshxhRAAAPl3ECe0WhLUAAAAAElFTkSuQmCC');
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            scroll-behavior: auto;
            will-change: scroll-position;
            touch-action: pan-y;
        }

        .message {
            max-width: 80%;
            margin-bottom: 3px;
            clear: both;
        }

        .message-content {
            padding: 8px 12px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
        }

        .message.sent {
            float: left;
        }

        .message.sent .message-content {
            background: #005c4b;
            color: #e9edef;
            border-top-left-radius: 0;
        }

        .message.received {
            float: right;
        }

        .message.received .message-content {
            background: #202c33;
            color: #e9edef;
            border-top-right-radius: 0;
        }

        .message-text {
            font-size: 0.95em;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .message-time {
            font-size: 0.7em;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 4px;
            justify-content: flex-end;
        }

        .message-time .check {
            color: #53bdeb;
        }

        .date-divider {
            text-align: center;
            margin: 15px 0;
            clear: both;
        }

        .date-divider span {
            background: #182229;
            color: rgba(255,255,255,0.65);
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 0.8em;
        }

        /* Input Area */
        .input-area {
            padding: 8px 10px;
            background: #202c33;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
        }

        .input-icons {
            color: #8696a0;
            font-size: 1.4em;
            cursor: pointer;
            padding: 8px;
        }

        .message-input-container {
            flex: 1;
            background: #2a3942;
            border-radius: 24px;
            display: flex;
            align-items: flex-end;
            padding: 8px 12px;
        }

        .message-input {
            flex: 1;
            background: none;
            border: none;
            color: #e9edef;
            font-size: 1em;
            outline: none;
            resize: none;
            max-height: 100px;
            line-height: 1.4;
        }

        .message-input::placeholder {
            color: #8696a0;
        }

        .send-btn {
            width: 48px;
            height: 48px;
            background: #00a884;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.3em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Empty/Loading States */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #8696a0;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #8696a0;
            padding: 20px;
        }

        .clearfix::after {
            content: '';
            display: table;
            clear: both;
        }

        /* Archived Section */
        .archived-section {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid rgba(134, 150, 160, 0.15);
            color: #00a884;
            font-size: 0.95em;
            gap: 20px;
        }

        .archived-section .icon {
            font-size: 1.2em;
        }

        /* Main Section Mobile */
        .main-section {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* ==================== DESKTOP STYLES ==================== */

        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
            }

            .main-section {
                width: 400px;
                flex: none;
                border-left: 1px solid #2a3942;
            }

            .bottom-nav {
                display: none;
            }

            .chat-view {
                position: relative;
                flex: 1;
                display: flex;
            }

            .chat-view .back-btn {
                display: none;
            }

            .chat-header {
                padding-top: 10px;
            }

            .input-area {
                padding-bottom: 8px;
            }

            .messages-area {
                padding: 20px 60px;
            }

            .message {
                max-width: 65%;
            }
        }

        /* Scrollbar - Hide on mobile, show on desktop */
        @media (max-width: 767px) {
            ::-webkit-scrollbar {
                display: none;
            }
            * {
                scrollbar-width: none;
            }
        }

        @media (min-width: 768px) {
            ::-webkit-scrollbar {
                width: 6px;
            }

            ::-webkit-scrollbar-track {
                background: transparent;
            }

            ::-webkit-scrollbar-thumb {
                background: #374045;
                border-radius: 3px;
            }
        }

        /* Media in messages */
        .message img {
            max-width: 100%;
            border-radius: 8px;
            cursor: pointer;
        }

        .message video {
            max-width: 100%;
            border-radius: 8px;
        }

        .message audio {
            max-width: 100%;
        }

        .media-placeholder {
            background: #2a3942;
            padding: 20px 30px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Main Section (Chat List) -->
        <div class="main-section" id="main-section">
            <!-- Header -->
            <div class="main-header">
                <h1>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</h1>
                <div class="header-icons">
                    <span onclick="loadChats()" title="ØªØ­Ø¯ÙŠØ«">ğŸ”„</span>
                    <a href="/export" title="ØªØµØ¯ÙŠØ±">ğŸ“¦</a>
                    <span>â‹®</span>
                </div>
            </div>

            <!-- Search -->
            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø£Ùˆ Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©" id="search-input" oninput="filterChats()">
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="setFilter('all', this)">Ø§Ù„ÙƒÙ„</button>
                <button class="filter-tab" onclick="setFilter('unread', this)">ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø© <span id="unread-count"></span></button>
                <button class="filter-tab" onclick="setFilter('groups', this)">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</button>
                <button class="filter-tab" onclick="showAllMessages('received')">ğŸ“¥ Ø§Ù„ÙˆØ§Ø±Ø¯</button>
                <button class="filter-tab" onclick="showAllMessages('sent')">ğŸ“¤ Ø§Ù„ØµØ§Ø¯Ø±</button>
            </div>

            <!-- Archived (optional) -->
            <div class="archived-section" style="display:none;">
                <span class="icon">ğŸ“</span>
                <span>Ø¯Ø±Ø¯Ø´Ø§Øª Ù…Ø¤Ø±Ø´ÙØ©</span>
            </div>

            <!-- Chat List -->
            <div class="chats-list" id="chats-list">
                <div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>

            <!-- Bottom Navigation -->
            <div class="bottom-nav">
                <div class="nav-item" onclick="window.location.href='/export'">
                    <div class="nav-icon-container">
                        <span class="nav-icon">âš™ï¸</span>
                    </div>
                    <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                </div>
                <div class="nav-item active">
                    <div class="nav-icon-container">
                        <span class="nav-icon">ğŸ’¬</span>
                        <span class="nav-badge" id="nav-unread"></span>
                    </div>
                    <span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</span>
                </div>
                <div class="nav-item" onclick="setFilter('groups')">
                    <div class="nav-icon-container">
                        <span class="nav-icon">ğŸ‘¥</span>
                    </div>
                    <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</span>
                </div>
                <div class="nav-item" onclick="showAllMessages('received')">
                    <div class="nav-icon-container">
                        <span class="nav-icon">ğŸ“¥</span>
                    </div>
                    <span>Ø§Ù„ÙˆØ§Ø±Ø¯</span>
                </div>
                <div class="nav-item" onclick="showAllMessages('sent')">
                    <div class="nav-icon-container">
                        <span class="nav-icon">ğŸ“¤</span>
                    </div>
                    <span>Ø§Ù„ØµØ§Ø¯Ø±</span>
                </div>
            </div>
        </div>

        <!-- Chat View -->
        <div class="chat-view" id="chat-view">
            <div class="chat-header">
                <span class="back-btn" onclick="closeChat()">â†</span>
                <div class="chat-header-avatar" id="chat-avatar">G</div>
                <div class="chat-header-info">
                    <div class="chat-header-name" id="chat-name">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©</div>
                    <div class="chat-header-status" id="chat-status">Ø§Ø¶ØºØ· Ù„Ù„Ù…Ø²ÙŠØ¯</div>
                </div>
                <div class="chat-header-icons">
                    <span>ğŸ“</span>
                    <span>â‹®</span>
                </div>
            </div>
            <div class="messages-area clearfix" id="messages-area">
                <div class="empty-state">
                    <h3 style="font-size:3em;margin-bottom:20px;">ğŸ’¬</h3>
                    <p>Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ø¨Ø¯Ø¡</p>
                </div>
            </div>
            <div class="input-area" id="input-area" style="display:none;">
                <span class="input-icons">ğŸ˜Š</span>
                <div class="message-input-container">
                    <input type="text" class="message-input" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©" onkeypress="if(event.key==='Enter')sendMessage()">
                </div>
                <button class="send-btn" onclick="sendMessage()">ğŸ“¤</button>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://api.ultramsg.com/instance100568';
        const TOKEN = 'e4e2cwhdsmxmjycg';

        let allChats = [];
        let currentChat = null;
        let isMobile = window.innerWidth < 768;

        // Check if mobile
        function checkMobile() {
            isMobile = window.innerWidth < 768;
            if (!isMobile) {
                document.getElementById('chat-view').classList.add('active');
            }
        }
        window.addEventListener('resize', checkMobile);
        checkMobile();

        async function loadChats() {
            try {
                document.getElementById('chats-list').innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª...</div>';

                const response = await fetch(`${API}/chats?token=${TOKEN}&limit=10000`);
                allChats = await response.json();

                // Sort by last_time
                allChats.sort((a, b) => (b.last_time || 0) - (a.last_time || 0));

                console.log('Total chats loaded:', allChats.length);

                // Count unread
                const unreadTotal = allChats.reduce((sum, c) => sum + (c.unread || 0), 0);
                document.getElementById('unread-count').textContent = unreadTotal > 0 ? `(${unreadTotal})` : '';
                const navUnread = document.getElementById('nav-unread');
                if (navUnread) navUnread.textContent = unreadTotal > 0 ? unreadTotal : '';

                renderChats(allChats);
            } catch(e) {
                console.error('Error loading chats:', e);
                document.getElementById('chats-list').innerHTML = '<div class="loading">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ - Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯ÙŠØ«</div>';
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diff = now - date;
            const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return date.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
            } else if (diffDays === 1) {
                return 'Ø£Ù…Ø³';
            } else if (diffDays < 7) {
                const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
                return days[date.getDay()];
            } else {
                return date.toLocaleDateString('ar-SA', {month: 'numeric', day: 'numeric'});
            }
        }

        function renderChats(chats) {
            const container = document.getElementById('chats-list');
            let html = '';

            chats.forEach(chat => {
                const isGroup = chat.id.includes('@g.us');
                const name = chat.name || chat.id.replace('@c.us', '').replace('@g.us', '');
                const initial = name.charAt(0).toUpperCase();
                const time = formatTime(chat.last_time);
                const unread = chat.unread || 0;
                const pinned = chat.pinned ? 'ğŸ“Œ ' : '';

                // Get preview from last message if available
                let preview = '';
                if (chat.last_message) {
                    if (chat.last_message.type === 'image') preview = 'ğŸ–¼ï¸ ØµÙˆØ±Ø©';
                    else if (chat.last_message.type === 'video') preview = 'ğŸ¬ ÙÙŠØ¯ÙŠÙˆ';
                    else if (chat.last_message.type === 'audio' || chat.last_message.type === 'ptt') preview = 'ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©';
                    else if (chat.last_message.type === 'document') preview = 'ğŸ“„ Ù…Ø³ØªÙ†Ø¯';
                    else preview = chat.last_message.body || '';
                }

                html += `
                    <div class="chat-item ${currentChat === chat.id ? 'active' : ''}" onclick="openChat('${chat.id}', '${name.replace(/'/g, "\\'")}')">
                        <div class="chat-avatar ${isGroup ? 'group-avatar' : ''}">
                            ${initial}
                        </div>
                        <div class="chat-info">
                            <div class="chat-top-row">
                                <span class="chat-name">${pinned}${isGroup ? 'ğŸ‘¥ ' : ''}${name}</span>
                                <span class="chat-time ${unread > 0 ? 'unread' : ''}">${time}</span>
                            </div>
                            <div class="chat-bottom-row">
                                <span class="chat-preview">${preview || 'Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©'}</span>
                                ${unread > 0 ? `<span class="unread-badge">${unread}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html || '<div class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>';
        }

        function filterChats() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = allChats.filter(chat => {
                const name = (chat.name || chat.id).toLowerCase();
                return name.includes(query);
            });
            renderChats(filtered);
        }

        function setFilter(type, btn) {
            document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            if (type === 'all') {
                renderChats(allChats);
            } else if (type === 'groups') {
                const groups = allChats.filter(c => c.id.includes('@g.us'));
                renderChats(groups);
            } else if (type === 'unread') {
                const unread = allChats.filter(c => c.unread > 0);
                renderChats(unread);
            }
        }

        async function openChat(chatId, name) {
            currentChat = chatId;

            // Update UI
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));

            // Show chat view on mobile
            if (isMobile) {
                document.getElementById('chat-view').classList.add('active');
            }

            // Update header
            document.getElementById('chat-name').textContent = name;
            document.getElementById('chat-avatar').textContent = name.charAt(0).toUpperCase();
            document.getElementById('chat-status').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            document.getElementById('input-area').style.display = 'flex';
            document.getElementById('messages-area').innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>';

            try {
                // Fetch messages
                const response = await fetch(`${API}/chats/messages?token=${TOKEN}&chatId=${chatId}&limit=100`);
                const messages = await response.json();

                // Try to get media from Firebase
                try {
                    const mediaResponse = await fetch(`/api/public/media?chatId=${chatId}&limit=100`);
                    const mediaData = await mediaResponse.json();

                    if (mediaData.success && mediaData.messages.length > 0) {
                        const mediaMap = new Map();
                        mediaData.messages.forEach(m => {
                            if (m.media && m.messageId) {
                                mediaMap.set(m.messageId, m.media);
                            }
                        });

                        messages.forEach(msg => {
                            if (!msg.media && mediaMap.has(msg.id)) {
                                msg.media = mediaMap.get(msg.id);
                            }
                        });
                    }
                } catch(e) {}

                document.getElementById('chat-status').textContent = `${messages.length} Ø±Ø³Ø§Ù„Ø©`;
                renderMessages(messages);
            } catch(e) {
                console.error('Error loading messages:', e);
                document.getElementById('messages-area').innerHTML = '<div class="loading">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
            }

            // Start auto-refresh
            startAutoRefresh();
        }

        function closeChat() {
            if (isMobile) {
                document.getElementById('chat-view').classList.remove('active');
            }
            currentChat = null;
            if (refreshInterval) clearInterval(refreshInterval);
        }

        function renderMessages(messages) {
            const container = document.getElementById('messages-area');
            let html = '';
            let lastDate = '';

            messages.reverse().forEach(msg => {
                const date = new Date(msg.timestamp * 1000);
                const dateStr = date.toLocaleDateString('ar-SA');
                const timeStr = date.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});

                if (dateStr !== lastDate) {
                    html += `<div class="date-divider"><span>${dateStr}</span></div>`;
                    lastDate = dateStr;
                }

                const direction = msg.fromMe ? 'sent' : 'received';

                let content = '';
                const mediaTypes = {
                    'image': 'ğŸ–¼ï¸ ØµÙˆØ±Ø©',
                    'video': 'ğŸ¬ ÙÙŠØ¯ÙŠÙˆ',
                    'audio': 'ğŸµ ØµÙˆØª',
                    'ptt': 'ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©',
                    'document': 'ğŸ“ Ù…Ù„Ù',
                    'sticker': 'ğŸ˜Š Ù…Ù„ØµÙ‚'
                };

                if (msg.media) {
                    if (msg.type === 'image') {
                        content = `<img src="${msg.media}" onclick="window.open('${msg.media}')" onerror="this.outerHTML='<div class=\\'media-placeholder\\'>ğŸ–¼ï¸</div>'">`;
                    } else if (msg.type === 'video') {
                        content = `<video src="${msg.media}" controls></video>`;
                    } else if (msg.type === 'audio' || msg.type === 'ptt') {
                        content = `<audio src="${msg.media}" controls></audio>`;
                    } else if (msg.type === 'document') {
                        content = `<a href="${msg.media}" target="_blank" style="color:#00a884;">ğŸ“ ${msg.filename || 'Ù…Ù„Ù'}</a>`;
                    } else if (msg.type === 'sticker') {
                        content = `<img src="${msg.media}" style="max-width:150px;">`;
                    }
                    if (msg.body) content += `<div class="message-text" style="margin-top:8px;">${escapeHtml(msg.body)}</div>`;
                } else if (mediaTypes[msg.type]) {
                    content = `<div class="media-placeholder">${mediaTypes[msg.type]}</div>`;
                    if (msg.body) content += `<div class="message-text" style="margin-top:8px;">${escapeHtml(msg.body)}</div>`;
                } else if (msg.body) {
                    content = `<div class="message-text">${escapeHtml(msg.body)}</div>`;
                } else if (msg.type === 'e2e_notification' || msg.type === 'gp2') {
                    return;
                } else {
                    content = `<div class="message-text" style="color:#8696a0;">[${msg.type || 'Ø±Ø³Ø§Ù„Ø©'}]</div>`;
                }

                html += `
                    <div class="message ${direction}">
                        <div class="message-content">
                            ${content}
                            <div class="message-time">
                                ${timeStr}
                                ${msg.fromMe ? '<span class="check">âœ“âœ“</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html || '<div class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</div>';
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message || !currentChat) return;

            const btn = document.querySelector('.send-btn');
            btn.textContent = 'â³';

            try {
                const isGroup = currentChat.includes('@g.us');
                const to = isGroup ? currentChat : currentChat.replace('@c.us', '');

                const response = await fetch(`${API}/messages/chat?token=${TOKEN}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `to=${encodeURIComponent(to)}&body=${encodeURIComponent(message)}`
                });

                const result = await response.json();

                if (result.sent) {
                    input.value = '';
                    const container = document.getElementById('messages-area');
                    const time = new Date().toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
                    container.innerHTML += `
                        <div class="message sent">
                            <div class="message-content">
                                <div class="message-text">${escapeHtml(message)}</div>
                                <div class="message-time">${time} <span class="check">âœ“</span></div>
                            </div>
                        </div>
                    `;
                    container.scrollTop = container.scrollHeight;
                } else {
                    alert('ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
                }
            } catch(e) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
            }

            btn.textContent = 'ğŸ“¤';
        }

        async function showAllMessages(type) {
            document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));

            if (isMobile) {
                document.getElementById('chat-view').classList.add('active');
            }

            document.getElementById('chat-name').textContent = type === 'sent' ? 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµØ§Ø¯Ø±Ø©' : 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©';
            document.getElementById('chat-avatar').textContent = type === 'sent' ? 'ğŸ“¤' : 'ğŸ“¥';
            document.getElementById('chat-status').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('messages-area').innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

            try {
                const response = await fetch(`${API}/messages?token=${TOKEN}&limit=500`);
                const data = await response.json();
                const messages = data.messages || [];

                const filtered = messages.filter(m => type === 'sent' ? m.fromMe : !m.fromMe);
                document.getElementById('chat-status').textContent = `${filtered.length} Ø±Ø³Ø§Ù„Ø©`;

                let html = '';
                let lastDate = '';

                filtered.forEach(msg => {
                    const date = new Date(msg.timestamp * 1000);
                    const dateStr = date.toLocaleDateString('ar-SA');
                    const timeStr = date.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});

                    if (dateStr !== lastDate) {
                        html += `<div class="date-divider"><span>${dateStr}</span></div>`;
                        lastDate = dateStr;
                    }

                    const chatName = msg.chatName || msg.from?.replace('@c.us', '').replace('@g.us', '') || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

                    let content = '';
                    const mediaLabels = {
                        'image': 'ğŸ–¼ï¸ ØµÙˆØ±Ø©',
                        'video': 'ğŸ¬ ÙÙŠØ¯ÙŠÙˆ',
                        'audio': 'ğŸµ ØµÙˆØª',
                        'ptt': 'ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©',
                        'document': 'ğŸ“ Ù…Ù„Ù',
                        'sticker': 'ğŸ˜Š Ù…Ù„ØµÙ‚'
                    };

                    if (msg.media) {
                        if (msg.type === 'image') {
                            content = `<img src="${msg.media}" style="max-width:200px;border-radius:8px;" onerror="this.outerHTML='<span>ğŸ–¼ï¸</span>'">`;
                        } else if (msg.type === 'video') {
                            content = `<video src="${msg.media}" controls style="max-width:200px;"></video>`;
                        } else if (msg.type === 'audio' || msg.type === 'ptt') {
                            content = `<audio src="${msg.media}" controls></audio>`;
                        } else if (msg.type === 'document') {
                            content = `<a href="${msg.media}" target="_blank" style="color:#00a884;">ğŸ“ ${msg.filename || 'Ù…Ù„Ù'}</a>`;
                        }
                    } else if (mediaLabels[msg.type]) {
                        content = `<div class="media-placeholder">${mediaLabels[msg.type]}</div>`;
                    } else if (msg.type === 'e2e_notification' || msg.type === 'gp2') {
                        return;
                    } else {
                        content = `<div class="message-text">${escapeHtml(msg.body || '[Ø±Ø³Ø§Ù„Ø©]')}</div>`;
                    }

                    html += `
                        <div class="message ${type === 'sent' ? 'sent' : 'received'}" style="max-width:90%;">
                            <div class="message-content">
                                <div style="font-size:0.75em;color:#00a884;margin-bottom:4px;">${chatName}</div>
                                ${content}
                                <div class="message-time">${timeStr}</div>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('messages-area').innerHTML = html || '<div class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</div>';
            } catch(e) {
                console.error(e);
                document.getElementById('messages-area').innerHTML = '<div class="loading">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
            }
        }

        // Auto-refresh
        let refreshInterval = null;

        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);

            refreshInterval = setInterval(async () => {
                if (!currentChat) return;

                try {
                    const response = await fetch(`${API}/chats/messages?token=${TOKEN}&chatId=${currentChat}&limit=100`);
                    const messages = await response.json();
                    renderMessages(messages);
                } catch(e) {
                    console.error('Auto-refresh error:', e);
                }
            }, 5000);
        }

        // Chat list refresh
        setInterval(async () => {
            try {
                const response = await fetch(`${API}/chats?token=${TOKEN}&limit=10000`);
                const newChats = await response.json();
                newChats.sort((a, b) => (b.last_time || 0) - (a.last_time || 0));

                if (JSON.stringify(newChats.map(c => c.last_time)) !== JSON.stringify(allChats.map(c => c.last_time))) {
                    allChats = newChats;
                    renderChats(allChats);

                    const unreadTotal = allChats.reduce((sum, c) => sum + (c.unread || 0), 0);
                    document.getElementById('unread-count').textContent = unreadTotal > 0 ? `(${unreadTotal})` : '';
                    const navUnread = document.getElementById('nav-unread');
                    if (navUnread) navUnread.textContent = unreadTotal > 0 ? unreadTotal : '';
                }
            } catch(e) {}
        }, 10000);

        // Init
        loadChats();
        console.log('WhatsApp Dashboard loaded');
    </script>
</body>
</html>
