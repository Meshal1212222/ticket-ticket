<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ultra Msg - Ù‚ÙˆÙ„Ø¯Ù† ØªÙŠÙƒØª</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; font-size: 2em; }

        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .card h2 { color: #4ecdc4; margin-bottom: 15px; }

        .btn {
            background: #4ecdc4;
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            font-weight: bold;
        }
        .btn:hover { background: #45b7aa; transform: translateY(-2px); }
        .btn:disabled { background: #666; cursor: not-allowed; transform: none; }
        .btn.danger { background: #e74c3c; }
        .btn.success { background: #27ae60; }

        .progress {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            height: 30px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(90deg, #4ecdc4, #27ae60);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-box h3 { font-size: 2em; color: #4ecdc4; }
        .stat-box p { color: #aaa; font-size: 0.9em; }

        .log-box {
            background: #0a0a15;
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85em;
            line-height: 1.6;
        }
        .log-box .info { color: #4ecdc4; }
        .log-box .success { color: #27ae60; }
        .log-box .error { color: #e74c3c; }
        .log-box .warning { color: #f39c12; }

        .data-preview {
            background: #0a0a15;
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow: auto;
            margin-top: 15px;
        }
        .data-preview pre {
            color: #4ecdc4;
            font-size: 0.8em;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .chat-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-right: 4px solid #4ecdc4;
        }
        .chat-item h4 { color: #4ecdc4; margin-bottom: 5px; }
        .chat-item p { color: #aaa; font-size: 0.9em; }
        .chat-item .msg-count {
            background: #27ae60;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            display: inline-block;
            margin-top: 5px;
        }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab-btn.active, .tab-btn:hover { background: #4ecdc4; color: #1a1a2e; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th { background: rgba(78,205,196,0.2); color: #4ecdc4; }
        tr:hover { background: rgba(255,255,255,0.05); }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .media-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .media-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .media-item .no-preview {
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 3em;
        }
        .media-item .info {
            padding: 8px;
            font-size: 0.75em;
            color: #aaa;
        }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .btn { width: 100%; margin: 5px 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ Ø£Ø¯Ø§Ø© ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ultra Msg</h1>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('export')">ğŸ“¥ Ø§Ù„ØªØµØ¯ÙŠØ±</button>
            <button class="tab-btn" onclick="showTab('chats')">ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</button>
            <button class="tab-btn" onclick="showTab('media')">ğŸ–¼ï¸ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</button>
            <button class="tab-btn" onclick="showTab('api')">ğŸ”Œ API</button>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØµØ¯ÙŠØ± -->
        <div id="export-tab">
            <div class="card">
                <h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-box">
                        <h3 id="stat-chats">-</h3>
                        <p>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</p>
                    </div>
                    <div class="stat-box">
                        <h3 id="stat-msgs">-</h3>
                        <p>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
                    </div>
                    <div class="stat-box">
                        <h3 id="stat-media">-</h3>
                        <p>Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</p>
                    </div>
                    <div class="stat-box">
                        <h3 id="stat-status">-</h3>
                        <p>Ø§Ù„Ø­Ø§Ù„Ø©</p>
                    </div>
                </div>
                <button class="btn" onclick="loadStats()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
            </div>

            <div class="card">
                <h2>ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
                <p style="margin-bottom:15px;color:#aaa;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªØµØ¯ÙŠØ±Ù‡Ø§:</p>

                <button class="btn" onclick="exportAllData()">ğŸ“¦ ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø´ÙŠØ¡ + Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</button>
                <button class="btn" onclick="exportQuick()">âš¡ ØªØµØ¯ÙŠØ± Ø³Ø±ÙŠØ¹</button>
                <button class="btn" onclick="exportChats()">ğŸ’¬ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙÙ‚Ø·</button>
                <button class="btn" onclick="exportMessages()">ğŸ“ ØªØµØ¯ÙŠØ± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙ‚Ø·</button>
                <button class="btn success" onclick="exportToCSV()">ğŸ“Š ØªØµØ¯ÙŠØ± CSV</button>

                <div class="progress" id="progress-container" style="display:none;">
                    <div class="progress-bar" id="progress-bar">0%</div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
                <div class="log-box" id="log-box">
                    <div class="info">ğŸš€ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡...</div>
                </div>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª -->
        <div id="chats-tab" style="display:none;">
            <div class="card">
                <h2>ğŸ’¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h2>
                <button class="btn" onclick="loadAllChats()">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</button>
                <div id="chats-list"></div>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· -->
        <div id="media-tab" style="display:none;">
            <div class="card">
                <h2>ğŸ–¼ï¸ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h2>
                <p style="color:#f39c12;margin-bottom:15px;">âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ù…Ù† Ultra Msg API. ÙÙ‚Ø· Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ø¨Ø± Webhook.</p>
                <button class="btn" onclick="loadMedia()">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ù…Ù† Firebase</button>
                <div class="media-grid" id="media-grid"></div>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ API -->
        <div id="api-tab" style="display:none;">
            <div class="card">
                <h2>ğŸ”Œ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª API</h2>
                <table>
                    <tr>
                        <th>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø©</th>
                        <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                    </tr>
                    <tr>
                        <td>Instance ID</td>
                        <td id="api-instance">instance100568</td>
                    </tr>
                    <tr>
                        <td>API URL</td>
                        <td>https://api.ultramsg.com/instance100568</td>
                    </tr>
                    <tr>
                        <td>Webhook URL</td>
                        <td>https://ticket-ticket-production.up.railway.app/webhook/ultramsg</td>
                    </tr>
                </table>

                <h3 style="margin-top:20px;color:#4ecdc4;">ğŸ”— Ø±ÙˆØ§Ø¨Ø· API Ø§Ù„Ù…ØªØ§Ø­Ø©:</h3>
                <div style="margin-top:10px;">
                    <p><code style="background:#0a0a15;padding:5px 10px;border-radius:5px;">GET /chats</code> - Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</p>
                    <p><code style="background:#0a0a15;padding:5px 10px;border-radius:5px;">GET /chats/messages?chatId=xxx</code> - Ø±Ø³Ø§Ø¦Ù„ Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                    <p><code style="background:#0a0a15;padding:5px 10px;border-radius:5px;">GET /messages?limit=100</code> - Ø¢Ø®Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
                    <p><code style="background:#0a0a15;padding:5px 10px;border-radius:5px;">GET /instance/status</code> - Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</p>
                </div>

                <h3 style="margin-top:20px;color:#f39c12;">âš ï¸ Ù‚ÙŠÙˆØ¯ Ultra Msg API:</h3>
                <ul style="margin-top:10px;color:#aaa;padding-right:20px;">
                    <li>Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ) ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©</li>
                    <li>Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· Ø¹Ø¨Ø± Webhook Ù„Ø­Ø¸Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</li>
                    <li>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 100-500 Ø±Ø³Ø§Ù„Ø© Ù„ÙƒÙ„ Ø·Ù„Ø¨</li>
                </ul>
            </div>
        </div>

        <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
        <div class="card" id="preview-card" style="display:none;">
            <h2>ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
            <button class="btn danger" onclick="document.getElementById('preview-card').style.display='none'">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
            <button class="btn success" onclick="downloadPreview()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„</button>
            <div class="data-preview">
                <pre id="data-preview"></pre>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://api.ultramsg.com/instance100568';
        const TOKEN = 'e4e2cwhdsmxmjycg';

        let exportData = null;

        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('export-tab').style.display = tab === 'export' ? 'block' : 'none';
            document.getElementById('chats-tab').style.display = tab === 'chats' ? 'block' : 'none';
            document.getElementById('media-tab').style.display = tab === 'media' ? 'block' : 'none';
            document.getElementById('api-tab').style.display = tab === 'api' ? 'block' : 'none';
        }

        function log(msg, type = 'info') {
            const box = document.getElementById('log-box');
            const time = new Date().toLocaleTimeString('ar-SA');
            box.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function updateProgress(percent) {
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-bar').textContent = percent + '%';
        }

        async function api(endpoint) {
            const url = `${API}/${endpoint}${endpoint.includes('?') ? '&' : '?'}token=${TOKEN}`;
            const response = await fetch(url);
            return response.json();
        }

        async function loadStats() {
            log('ğŸ“Š Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...');
            try {
                // Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                const status = await api('instance/status');
                const isConnected = status.status?.accountStatus?.status === 'authenticated';
                document.getElementById('stat-status').textContent = isConnected ? 'âœ…' : 'âŒ';

                // Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
                const chats = await api('chats');
                document.getElementById('stat-chats').textContent = chats.length || 0;

                // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                const msgs = await api('messages?limit=1');
                document.getElementById('stat-msgs').textContent = (msgs.total || 0).toLocaleString();

                // Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (ØªÙ‚Ø¯ÙŠØ±ÙŠ)
                document.getElementById('stat-media').textContent = '~';

                log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'success');
            } catch(e) {
                log('âŒ Ø®Ø·Ø£: ' + e.message, 'error');
            }
        }

        async function exportAllData() {
            log('ğŸ“¦ Ø¨Ø¯Ø¡ ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·)...');
            updateProgress(0);

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ØªÙŠ ØªØ­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
                log('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…...');
                updateProgress(20);

                const response = await fetch('/api/export/all');
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }

                updateProgress(80);

                const data = result.data;
                log(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${data.stats.totalChats} Ù…Ø­Ø§Ø¯Ø«Ø©`, 'success');
                log(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${data.stats.totalMessages} Ø±Ø³Ø§Ù„Ø©`, 'success');
                log(`ğŸ“· Ø¹Ø¯Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·: ${data.stats.mediaMessages}`, 'info');

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                if (data.mediaMessages.length > 0) {
                    log('ğŸ–¼ï¸ Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©...');

                    let mediaFetched = 0;
                    for (let i = 0; i < Math.min(data.mediaMessages.length, 20); i++) {
                        const msg = data.mediaMessages[i];
                        if (!msg.media && msg.messageId) {
                            try {
                                const mediaRes = await fetch(`/api/export/media/${msg.messageId}`);
                                const mediaData = await mediaRes.json();
                                if (mediaData.success && mediaData.media) {
                                    data.mediaMessages[i].media = mediaData.media;
                                    data.mediaMessages[i].mediaSource = mediaData.source;
                                    mediaFetched++;
                                }
                            } catch(e) {}
                        }
                        updateProgress(80 + Math.round((i / 20) * 15));
                    }

                    if (mediaFetched > 0) {
                        log(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${mediaFetched} Ø±Ø§Ø¨Ø· ÙˆØ³Ø§Ø¦Ø·`, 'success');
                    } else {
                        log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±ÙˆØ§Ø¨Ø· ÙˆØ³Ø§Ø¦Ø· Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©', 'warning');
                    }
                }

                updateProgress(100);

                // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                exportData = data;
                document.getElementById('data-preview').textContent = JSON.stringify(data, null, 2);
                document.getElementById('preview-card').style.display = 'block';

            } catch(e) {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + e.message, 'error');
            }
        }

        // ØªØµØ¯ÙŠØ± Ø³Ø±ÙŠØ¹ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
        async function exportQuick() {
            log('ğŸ“¦ Ø¨Ø¯Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø±ÙŠØ¹...');
            updateProgress(0);

            try {
                const data = {
                    exportDate: new Date().toISOString(),
                    instance: 'instance100568',
                    chats: [],
                    messages: [],
                    totalMessages: 0
                };

                // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
                log('ğŸ’¬ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª...');
                updateProgress(10);
                const chats = await api('chats');
                data.chats = chats;
                log(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${chats.length} Ù…Ø­Ø§Ø¯Ø«Ø©`, 'success');

                // 2. Ø¬Ù„Ø¨ Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ„ Ù…Ø­Ø§Ø¯Ø«Ø©
                let totalMsgs = 0;
                for (let i = 0; i < chats.length; i++) {
                    const chat = chats[i];
                    const progress = 10 + Math.round((i / chats.length) * 80);
                    updateProgress(progress);

                    log(`ğŸ“ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø±Ø³Ø§Ø¦Ù„: ${chat.name || chat.id}`);

                    try {
                        const msgs = await fetch(`${API}/chats/messages?token=${TOKEN}&chatId=${chat.id}&limit=500`).then(r => r.json());

                        if (Array.isArray(msgs)) {
                            data.messages.push({
                                chatId: chat.id,
                                chatName: chat.name,
                                messages: msgs
                            });
                            totalMsgs += msgs.length;
                        }
                    } catch(e) {
                        log(`âš ï¸ ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø±Ø³Ø§Ø¦Ù„ ${chat.id}`, 'warning');
                    }

                    // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„ØªØ¬Ù†Ø¨ rate limiting
                    await new Promise(r => setTimeout(r, 200));
                }

                data.totalMessages = totalMsgs;
                updateProgress(100);

                log(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${totalMsgs} Ø±Ø³Ø§Ù„Ø© Ù…Ù† ${chats.length} Ù…Ø­Ø§Ø¯Ø«Ø©`, 'success');

                // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                exportData = data;
                document.getElementById('data-preview').textContent = JSON.stringify(data, null, 2);
                document.getElementById('preview-card').style.display = 'block';

            } catch(e) {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + e.message, 'error');
            }
        }

        async function exportChats() {
            log('ğŸ’¬ Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª...');
            try {
                const chats = await api('chats');
                exportData = { exportDate: new Date().toISOString(), chats };
                document.getElementById('data-preview').textContent = JSON.stringify(exportData, null, 2);
                document.getElementById('preview-card').style.display = 'block';
                log(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${chats.length} Ù…Ø­Ø§Ø¯Ø«Ø©`, 'success');
            } catch(e) {
                log('âŒ Ø®Ø·Ø£: ' + e.message, 'error');
            }
        }

        async function exportMessages() {
            log('ğŸ“ Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ø¢Ø®Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...');
            try {
                const msgs = await api('messages?limit=500');
                exportData = { exportDate: new Date().toISOString(), messages: msgs.messages || msgs };
                document.getElementById('data-preview').textContent = JSON.stringify(exportData, null, 2);
                document.getElementById('preview-card').style.display = 'block';
                log(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„`, 'success');
            } catch(e) {
                log('âŒ Ø®Ø·Ø£: ' + e.message, 'error');
            }
        }

        async function exportToCSV() {
            log('ğŸ“Š Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù CSV...');
            try {
                const msgs = await api('messages?limit=1000');
                const messages = msgs.messages || msgs || [];

                // Ø¥Ù†Ø´Ø§Ø¡ CSV
                let csv = 'Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ù…Ø±Ø³Ù„,Ø§Ù„Ù…Ø³ØªÙ„Ù…,Ø§Ù„Ø±Ø³Ø§Ù„Ø©,Ø§Ù„Ù†ÙˆØ¹,Ù…Ù†ÙŠ\n';
                messages.forEach(m => {
                    const date = new Date(m.created_at * 1000).toLocaleString('ar-SA');
                    const body = (m.body || '').replace(/"/g, '""').replace(/\n/g, ' ');
                    csv += `"${date}","${m.from || ''}","${m.to || ''}","${body}","${m.type || ''}","${m.fromMe ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}"\n`;
                });

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ultramsg_export_${Date.now()}.csv`;
                a.click();

                log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù CSV', 'success');
            } catch(e) {
                log('âŒ Ø®Ø·Ø£: ' + e.message, 'error');
            }
        }

        function downloadPreview() {
            if (!exportData) return;

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ultramsg_export_${Date.now()}.json`;
            a.click();

            log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù', 'success');
        }

        async function loadAllChats() {
            const container = document.getElementById('chats-list');
            container.innerHTML = '<p style="color:#aaa;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';

            try {
                const chats = await api('chats');
                let html = '';

                for (const chat of chats) {
                    // Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ÙƒÙ„ Ù…Ø­Ø§Ø¯Ø«Ø©
                    let msgCount = 0;
                    try {
                        const msgs = await fetch(`${API}/chats/messages?token=${TOKEN}&chatId=${chat.id}&limit=1`).then(r => r.json());
                        msgCount = Array.isArray(msgs) ? msgs.length : 0;
                    } catch(e) {}

                    html += `
                        <div class="chat-item">
                            <h4>${chat.name || chat.id.replace(/@.+/, '')}</h4>
                            <p>${chat.id}</p>
                            <span class="msg-count">${msgCount > 0 ? msgCount + ' Ø±Ø³Ø§Ù„Ø©' : 'ÙØ§Ø±ØºØ©'}</span>
                        </div>
                    `;
                }

                container.innerHTML = html || '<p style="color:#aaa;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª</p>';
            } catch(e) {
                container.innerHTML = '<p style="color:#e74c3c;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>';
            }
        }

        async function loadMedia() {
            const container = document.getElementById('media-grid');
            container.innerHTML = '<p style="color:#aaa;grid-column:1/-1;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';

            try {
                // Ø¬Ù„Ø¨ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ù…Ù† Firebase
                const response = await fetch('/api/public/media?limit=50');
                const data = await response.json();

                if (!data.success || !data.messages.length) {
                    container.innerHTML = '<p style="color:#aaa;grid-column:1/-1;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ø· Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Firebase</p>';
                    return;
                }

                let html = '';
                data.messages.forEach(m => {
                    const isImage = m.type === 'image' || m.mimetype?.startsWith('image/');
                    const time = new Date(m.timestamp).toLocaleString('ar-SA');

                    html += `
                        <div class="media-item">
                            ${m.media && isImage ?
                                `<img src="${m.media}" alt="media" onerror="this.parentElement.innerHTML='<div class=\\'no-preview\\'>âŒ</div><div class=\\'info\\'>Ø±Ø§Ø¨Ø· Ù…Ù†ØªÙ‡ÙŠ</div>'">` :
                                `<div class="no-preview">${m.type === 'video' ? 'ğŸ¥' : m.type === 'audio' ? 'ğŸµ' : 'ğŸ“„'}</div>`
                            }
                            <div class="info">
                                ${m.type} - ${time}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch(e) {
                container.innerHTML = '<p style="color:#e74c3c;grid-column:1/-1;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + e.message + '</p>';
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        loadStats();
    </script>
</body>
</html>
